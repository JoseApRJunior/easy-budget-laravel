{% extends "layout.twig" %}

{% block content %}
<div class="container-fluid py-1">
	{# Header Section #}
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1>Novo Serviço</h1>
	</div>
	{# TODO CORRIGIR LOGICA DE VALIDAÇAO DE CRIAÇAO DE SERVIÇO COLOCAR ORÇAMENTO OBRIGATORIO ##}
	{# Search Section #}
	{% if code == 0 %}
	<div class="card shadow-sm mb-4">
		<div class="card-body">
			<div class="row">
				<div class="col-md-4">
					<div class="search-container">
						<label for="search-input" class="form-label">
							Buscar Orçamento por Código ou Nome do Cliente:
						</label>
						<input type="search" id="search-input" name="search-input" placeholder="Buscar orçamento"
							class="form-control">
					</div>
				</div>
			</div>
			<div class="table-responsive mt-3">
				<table class="table table-striped" id="budgets-table">
					<tbody id="services-tbody"></tbody>
				</table>
			</div>
		</div>
	</div>
	{% endif %}
	{# Service Form #}
	<form id="create-service-form" action="/provider/services/create" method="POST" enctype="multipart/form-data">
		{{ csrf.field|raw }}

		<div class="card shadow-sm">
			<div class="card-body">
				{# Basic Information Section #}
				<div class="row g-3 mb-4">
					<div class="col-md-3">
						<div class="form-group">
							<label for="code" class="form-label">Código de Orçamento:</label>
							<input type="text" id="code" name="code" class="form-control" readonly value="{{ code }}">
							{{ flash('code') | raw }}
						</div>
					</div>

					<div class="col-md-3">
						<div class="form-group">
							<label for="service-category" class="form-label">Categoria:</label>
							<select id="service-category" name="category" class="form-control">
								<option value="">Selecione uma categoria</option>
								{% for category in categories %}
								<option value="{{ category.id }}" {% if category.name=='Outros' %}selected{% endif %}>
									{{ category.name }}
								</option>
								{% endfor %}
							</select>
							{{ flash('category') | raw }}
						</div>
					</div>

					<div class="col-md-3">
						<div class="form-group">
							<label for="due-date" class="form-label">Previsão de Vencimento:</label>
							{% set now = date() %}
							{% set oneMonthAhead = now|date_modify('+1 month') %}
							<input type="date" id="due-date" name="due_date" class="form-control"
								value="{{ oneMonthAhead|date('Y-m-d') }}">
							{{ flash('due_date')|raw }}
						</div>
					</div>
				</div>

				{# Description Section #}
				<div class="row mb-4">
					<div class="col-12">
						<div class="form-group">
							<label for="description" class="form-label">Descrição</label>
							<textarea class="form-control" id="description" name="description" rows="2" maxlength="250"></textarea>
							{{ flash('description') | raw }}
							<div class="text-muted small mt-1" id="char-count">
								Caracteres restantes: <span id="char-count-value">250</span>
							</div>
						</div>
					</div>
				</div>

				{# Visual Separator #}
				<div class="row">
					<div class="col-12">
						<div class="border-bottom border-2 my-4"></div>
					</div>
				</div>

				{# Items Table Section #}
				<div class="row mb-4">
					<div class="col-12">
						<div class="form-group">
							<label for="items-table" class="form-label">Itens do Serviço</label>
							<div class="table-responsive">
								<table id="items-table" class="table table-striped">
									<thead>
										<tr>
											<th class="col-md-1">#</th>
											<th class="col-md-1">Código</th>
											<th class="col-md-4">Nome</th>
											<th class="col-md-2">Valor Unitário</th>
											<th class="col-md-1">Quantidade</th>
											<th class="col-md-2">Total do Item</th>
											<th class="col-md-1">Ações</th>
										</tr>
									</thead>
									<tbody id="items-tbody"></tbody>
									<tfoot>
										<tr>
											<td colspan="7" class="text-end">
												Total do Serviço: <span id="total-service">R$ 0,00</span>
											</td>
										</tr>
									</tfoot>
								</table>
							</div>
							<button type="button" id="add-item-button" class="btn btn-primary mt-3">
								<i class="bi bi-plus-circle me-2"></i>Adicionar Item
							</button>
						</div>
					</div>
				</div>

				{# Submit Button #}
				<div class="row">
					<div class="col-12">
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-check-circle me-2"></i>Criar Serviço
						</button>
					</div>
				</div>
			</div>
		</div>
	</form>
</div>
{% endblock %}

{% block styles %}
{{ parent() }}
<link rel="stylesheet" href="/assets/css/pagination.css">
{% endblock %}

{% block scripts %}
{{ parent() }}
<script>
	// Dados iniciais
	const budgets = JSON.parse( '{{ budgets | json_encode | e("js") }}' );
	const products = JSON.parse( '{{ products | json_encode | e("js") }}' );
</script>
<script src="/assets/js/service_create.js"></script>
{% endblock %}
