{% extends "layout.twig" %}

{% block content %}
<div class="container-fluid py-1">
	<!-- Cabeçalho da página -->
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1 class="h3 mb-0">
			<i class="bi bi-tools me-2"></i>Editar Serviço
		</h1>
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb mb-0">
				<li class="breadcrumb-item"><a href="/provider">Dashboard</a></li>
				<li class="breadcrumb-item"><a href="/provider/services">Serviços</a></li>
				<li class="breadcrumb-item"><a href="/provider/services/show/{{ service.code }}">{{ service.code }}</a></li>
				<li class="breadcrumb-item active">Editar</li>
			</ol>
		</nav>
	</div>
	<!-- Formulário -->
	<div class="card border-0 shadow-sm">
		<div class="card-body p-4">
			<form id="update-service-form" action="/provider/services/update" method="POST">
				{{ csrf.field|raw }}
				<input type="hidden" name="id" value="{{ service.id }}">
				<fieldset {% if service.status_slug !='DRAFT' %}disabled{% endif %}>

					<!-- Informações do Serviço -->
					<div class="row mb-4">
						<div class="col-md-3">
							<div class="form-group">
								<label class="form-label fw-semibold">
									<i class="bi bi-hash me-2"></i>Código
								</label>
								<input type="text" class="form-control bg-light" value="{{ service.code }}" disabled>
								<input type="hidden" name="code" value="{{ service.code }}">
								{{ flash('code')|raw }}
							</div>
						</div>
						<div class="col-md-2">
							<div class="form-group">
								<label class="form-label fw-semibold">
									<i class="bi bi-calendar-check me-2"></i>Data de Criação
								</label>
								<input type="text" class="form-control bg-light" value="{{ service.created_at|date('d/m/Y H:i') }}"
									disabled>
							</div>
						</div>
						<div class="col-md-2">
							<div class="form-group">
								<label for="budget_code" class="form-label fw-semibold">
									<i class="bi bi-file-earmark-text me-2"></i>Orçamento
								</label>
								<input type="text" class="form-control bg-light" value="{{ service.budget_code }}" disabled>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label for="category" class="form-label fw-semibold">
									<i class="bi bi-bookmark me-2"></i>Categoria
								</label>
								<select id="category" name="category" class="form-select" required>
									<option value="">Selecione uma categoria</option>
									{% for category in categories %}
									<option value="{{ category.id }}" {% if category.id==service.category_id %}selected{% endif %}>
										{{ category.name }}
									</option>
									{% endfor %}
								</select>
								{{ flash('category_id')|raw }}
							</div>
						</div>
						<!-- Data de Vencimento -->
						<div class="col-md-2">
							<div class="form-group">
								<label for="due_date" class="form-label fw-semibold">
									<i class="bi bi-calendar me-2"></i>Previsão de Vencimento
								</label>
								<input type="date" id="due_date" name="due_date" class="form-control date-input-br"
									value="{{ service.due_date|date('Y-m-d') }}" required />
								<div class="invalid-date-feedback" id="due_date_feedback"></div>
								{{ flash('due_date')|raw }}
							</div>
						</div>
					</div>

					<!-- Seção de Cliente e Categoria -->
					<div class="row g-4">
						<div class="col-md-4">
							<div class="form-group">
								<label class="form-label fw-semibold">
									<i class="bi bi-person me-2"></i>Cliente
								</label>
								<!-- Campo visível mas desabilitado para o usuário -->
								<input type="text" class="form-control bg-light" value="{{ service.customer_name }}" disabled>
								{{ flash('customer_name')|raw }}
							</div>
						</div>

						<!-- Descrição -->
						<div class="col-md-8">
							<div class="form-group">
								<label for="description" class="form-label fw-semibold">
									<i class="bi bi-card-text me-2"></i>Descrição
								</label>
								<textarea id="description" name="description" class="form-control" rows="3" maxlength="255"
									placeholder="Descreva o serviço detalhadamente">{{ service.description }}</textarea>
								<div class="d-flex justify-content-end">
									<small id="char-count" class="text-muted mt-2">
										<span>{{ 255 - (service.description|length) }}</span> caracteres restantes
									</small>
								</div>
								{{ flash('description')|raw }}
							</div>
						</div>
					</div>

					<!-- Itens do Serviço -->
					<div class="mt-5">
						<h5 class="mb-3">
							<i class="bi bi-list-check me-2"></i>Itens do Serviço
						</h5>

						<div class="table-responsive">
							<table id="items-table" class="table table-hover">
								<thead class="table-light">
									<tr>
										<th style="width: 5%">#</th>
										<th style="width: 10%">Código</th>
										<th style="width: 30%">Produto</th>
										<th style="width: 15%">Valor Unitário</th>
										<th style="width: 10%">Quantidade</th>
										<th style="width: 15%">Total</th>
										<th style="width: 15%">Ações</th>
									</tr>
								</thead>
								<tbody id="items-tbody"></tbody>
								<tfoot>
									<tr>
										<td colspan="5" class="text-end fw-bold">Total do Serviço:</td>
										<td colspan="2" class="fw-bold text-success">
											<span id="total-service">R$ {{ service.total|number_format(2, ',', '.') }}</span>
										</td>
									</tr>
								</tfoot>
							</table>
						</div>

						<div class="mt-3">
							<button type="button" id="add-item-button" class="btn btn-outline-primary">
								<i class="bi bi-plus-circle me-2"></i>Adicionar Item
							</button>
						</div>
					</div>
				</fieldset>
			</form>
			<!-- Botões de ação do formulário e navegação -->
			<div class="d-flex justify-content-between mt-4 pt-4 border-top">
				<div>
					<a href="/provider/services/show/{{ service.code }}" class="btn btn-outline-secondary px-4"
						data-bs-toggle="tooltip" title="Voltar para detalhes sem salvar">
						<i class="bi bi-x-circle me-2"></i>Cancelar
					</a>
				</div>
				<div>
					{% if service.status_slug == 'DRAFT' %}
					<button type="submit" form="update-service-form" class="btn btn-primary px-4" data-bs-toggle="tooltip"
						title="Salvar as alterações feitas no serviço">
						<i class="bi bi-check-lg me-2"></i>Salvar Alterações
					</button>
					{% elseif service.status_slug == 'SCHEDULING' %}
					<div class="alert alert-warning mb-0 py-2 px-3" role="alert" data-bs-toggle="tooltip"
						title="Este serviço está aguardando agendamento e não pode ser modificado.">
						<i class="bi bi-exclamation-triangle-fill me-2"></i>Aguardando agendamento
					</div>
					{% else %}
					<div class="alert alert-info mb-0 py-2 px-3" role="alert" data-bs-toggle="tooltip"
						title="Este serviço não pode ser editado no status atual: {{ service.status_name }}.">
						<i class="bi bi-info-circle-fill me-2"></i>Não Editável ({{ service.status_name }})
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Modal de Adicionar Item -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addItemModalLabel">Adicionar Item ao Serviço</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="row mb-3">
					<div class="col-md-12">
						<div class="input-group">
							<input type="text" id="product-search" class="form-control"
								placeholder="Buscar produto por nome ou código...">
							<button class="btn btn-outline-secondary" type="button" id="search-button">
								<i class="bi bi-search"></i>
							</button>
						</div>
					</div>
				</div>

				<div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
					<table class="table table-hover" id="products-table">
						<thead class="table-light sticky-top">
							<tr>
								<th>Código</th>
								<th>Nome</th>
								<th>Preço</th>
								<th>Ações</th>
							</tr>
						</thead>
						<tbody id="products-list">
							<!-- Produtos serão carregados aqui -->
						</tbody>
					</table>
				</div>

				<div id="selected-product-form" class="mt-4 d-none">
					<h6 class="mb-3">Produto Selecionado</h6>
					<div class="row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="selected-product-name" class="form-label">Nome</label>
								<input type="text" id="selected-product-name" class="form-control" readonly>
								<input type="hidden" id="selected-product-id">
							</div>
						</div>
						<div class="col-md-2">
							<div class="form-group">
								<label for="selected-product-price" class="form-label">Preço</label>
								<input type="text" id="selected-product-price" class="form-control money-input" readonly>
							</div>
						</div>
						<div class="col-md-2">
							<div class="form-group">
								<label for="selected-product-quantity" class="form-label">Quantidade</label>
								<input type="number" id="selected-product-quantity" class="form-control" value="1" min="1">
							</div>
						</div>
						<div class="col-md-2">
							<div class="form-group">
								<label for="selected-product-total" class="form-label">Total</label>
								<input type="text" id="selected-product-total" class="form-control money-input" readonly>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				<button type="button" class="btn btn-primary" id="confirm-add-item" disabled>Adicionar Item</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal de Cancelamento -->
<div class="modal fade" id="cancelServiceModal" tabindex="-1" aria-labelledby="cancelServiceModalLabel"
	aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="cancelServiceModalLabel">Cancelar Serviço</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>Tem certeza que deseja cancelar o serviço <strong>{{ service.code }}</strong>?</p>
				<p class="text-danger"><strong>Atenção:</strong> Esta ação não pode ser desfeita.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Voltar</button>
				<form action="/provider/services/cancel/{{ service.id }}" method="POST">
					{{ csrf.field|raw }}
					<button type="submit" class="btn btn-danger">Confirmar Cancelamento</button>
				</form>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ parent() }}
<!-- Inclusão dos plugins de máscara -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script src="/assets/js/modules/masks/masks.js" type="module"></script>
<script>
	// Dados iniciais
	const service = JSON.parse( '{{ service | json_encode | e("js") }}' );
	const serviceItems = JSON.parse( '{{ serviceItems | json_encode | e("js") }}' );
	const products = JSON.parse( '{{ products | json_encode | e("js") }}' );
</script>
<script src="/assets/js/service_update.js"></script>

{% endblock %}
