{% extends "layout.twig" %}

{% block content %}
<div class="container-fluid py-1">
	{# Cabeçalho #}
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1 class="h3 mb-0 text-gray-800">
			<i class="bi bi-file-earmark-bar-graph me-2"></i>Relatório de Orçamentos
		</h1>
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb mb-0">
				<li class="breadcrumb-item"><a href="/provider">Dashboard</a></li>
				<li class="breadcrumb-item"><a href="/provider/report">Relatórios</a></li>
				<li class="breadcrumb-item active" aria-current="page">Orçamentos</li>
			</ol>
		</nav>
	</div>

	{# Filtros #}
	<div class="card border-0 shadow-sm mb-4">
		<div class="card-body p-4">
			<form id="filter-form" class="row g-3">
				{{ csrf.field|raw }}

				<!-- Nº Orçamento -->
				<div class="col-md-2">
					<div class="form-floating">
						<input type="text" class="form-control " id="code" name="code" placeholder="Nº Orçamento"
							value="{{ filters.code ?? '' }}">
						<label for="code">
							<i class="bi bi-hash me-1"></i>Nº Orçamento
						</label>
					</div>
				</div>

				<!-- Data Inicial -->
				<div class="col-md-2" style="position: relative;">
					<div class="form-floating">
						<input type="date" class="form-control " id="start_date" name="start_date" placeholder="Data Inicial"
							pattern="\d{4}-\d{2}-\d{2}" value="{{ filters.start_date ?? '' }}">
						<label for="start_date">
							<i class="bi bi-calendar-event me-1"></i>Data Inicial
						</label>
					</div>
				</div>

				<!-- Data Final -->
				<div class="col-md-2" style="position: relative;">
					<div class="form-floating">
						<input type="date" class="form-control " id="end_date" name="end_date" placeholder="Data Final"
							pattern="\d{4}-\d{2}-\d{2}" value="{{ filters.end_date ?? '' }}">
						<label for="end_date">
							<i class="bi bi-calendar-event me-1"></i>Data Final
						</label>
					</div>
				</div>

				<!-- Cliente -->
				<div class="col-md-2">
					<div class="form-floating position-relative">
						<input type="text" class="form-control" id="customer_name" name="customer_name"
							placeholder="Digite nome, CPF ou CNPJ" value="{{ filters.customer_name ?? '' }}" autocomplete="off"
							data-bs-toggle="tooltip" data-bs-placement="top" title="Busque por nome, CPF ou CNPJ do cliente">
						<label for="customer_name">
							<i class="bi bi-person me-1"></i>Cliente
						</label>
					</div>
					<!-- Texto auxiliar -->
					<div class="form-text text-muted small mt-1">
						<i class="bi bi-info-circle me-1"></i>
						Pesquise por nome, CPF ou CNPJ
					</div>
				</div>
				budget_status_options

				<div class="col-md-2">
					<div class="form-floating">
						<input type="text" class="form-control money-input" id="total" name="total" placeholder="Valor Mínimo"
							value="{{ filters.total ? filters.total|number_format(2, ',', '.') : '' }}" autocomplete="off"
							maxlength="20">
						<label for="total">
							<i class="bi bi-currency-dollar me-1"></i>Valor Mínimo
						</label>
					</div>
				</div>


				<!-- Status -->
				<div class="col-md-2">
					<div class="form-floating">
						<select class="form-select" id="status" name="status">
							{{ filters.status|budget_status_options|raw }}
						</select>
						<label for="status">
							<i class="bi bi-flag me-1"></i>Status
						</label>
					</div>
				</div>

				<!-- Botões -->
				<div class="col-12 d-flex justify-content-end gap-2 mt-4">
					<button type="button" id="clear-filters" class="btn btn-light btn-lg px-4">
						<i class="bi bi-x-circle me-2"></i>Limpar
					</button>
					<button type="submit" class="btn btn-primary btn-lg px-4">
						<i class="bi bi-search me-2"></i>Filtrar
					</button>
				</div>
			</form>
		</div>
	</div>

	{# Mensagem Inicial #}
	<div id="initial-message"
		class="card border-0 shadow-sm text-center py-1 {% if budgets is defined %}d-none{% endif %}">
		<div class="card-body">
			<i class="bi bi-funnel-fill text-primary mb-3" style="font-size: 3rem;"></i>
			<h5 class="text-gray-800 mb-3">Utilize os filtros acima para gerar o relatório</h5>
			<p class="text-muted mb-0">
				Configure os critérios desejados e clique em "Filtrar" para visualizar os resultados
			</p>
		</div>
	</div>

	{# Loading Spinner #}
	<div id="loading-spinner" class="d-none">
		<div class="card border-0 shadow-sm">
			<div class="card-body text-center py-1">
				<div class="spinner-border text-primary" role="status">
					<span class="visually-hidden">Carregando...</span>
				</div>
				<p class="text-muted mt-3 mb-0">Processando sua solicitação...</p>
			</div>
		</div>
	</div>

	{# Resultados #}
	<div id="results-container" class="d-none">
		<div class="card border-0 shadow-sm">
			{# Cabeçalho dos Resultados #}
			<div class="card-header bg-transparent border-0">
				<div class="d-flex justify-content-between align-items-center">
					<span id="results-count" class="text-muted">
						{% if budgets is defined %}
						Mostrando {{ budgets|length }} resultados
						{% endif %}
					</span>
					<div class="btn-group">
						<button type="button" class="btn btn-outline-primary" title="Exportar PDF" id="export-pdf">
							<i class="bi bi-file-pdf me-2"></i>PDF
						</button>
						<button type="button" class="btn btn-outline-primary" title="Exportar Excel" id="export-excel">
							<i class="bi bi-file-excel me-2"></i>Excel
						</button>
					</div>
				</div>
			</div>

			{# Tabela de Resultados #}
			<div class="card-body p-0">
				<div class="table-responsive">
					<table id="results-table" class="table table-hover align-middle mb-0">
						<thead>
							<tr>
								<th style="width: 10%; text-align: left;">Nº Orçamento</th>
								<th style="width: 20%; text-align: left;">Cliente</th>
								<th style="width: 30%; text-align: left;">Descrição</th>
								<th style="width: 10%; text-align: left;">Data Criação</th>
								<th style="width: 10%; text-align: left;">Data Vencimento</th>
								<th style="width: 10%; text-align: right;">Valor Total</th>
								<th style="width: 10%; text-align: right;">Status</th>
							</tr>
						</thead>
						<tbody>
							{# Será preenchido via JavaScript #}
						</tbody>
					</table>
				</div>
			</div>

			{# Paginação #}
			{% if budgets is defined and budgets|length > 0 %}
			<div class="card-footer bg-transparent border-0">
				<div class="d-flex justify-content-between align-items-center">
					<div class="text-muted small">
						Total: {{ budgets|length }} registros
					</div>
					<nav aria-label="Navegação de páginas">
						<ul class="pagination pagination-sm mb-0">
							<!-- ... sua paginação atual ... -->
						</ul>
					</nav>
				</div>
			</div>
			{% endif %}
		</div>
	</div>
</div>

{% endblock %}

{% block scripts %}
<!-- Adicione a biblioteca SheetJS -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="/assets/js/budget.js"></script>
<script src="/assets/js/budget_report.js"></script>
{% endblock %}
