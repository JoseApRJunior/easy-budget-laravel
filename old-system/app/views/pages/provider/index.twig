{% extends "layout.twig" %}

{% block content %}
<div class="container-fluid py-1">
	{% if checkPlan().slug == 'free' or checkPlanPending().status == 'pending' %}
	<div class=" modal fade" id="planAlertModal" tabindex="-1" aria-labelledby="planAlertModalLabel">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content border-0">
				{# Header do Modal #}
				<div class="modal-header border-0 ">
					<div class="d-flex align-items-center">
						<i class="bi bi-info-circle text-primary me-2"></i>
						<h5 class="modal-title" id="planAlertModalLabel">
							Informação do Plano
						</h5>
					</div>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
				</div>

				{# Corpo do Modal #}
				<div class="modal-body">
					{% if checkPlanPending().status == 'pending' %}
					<p class="text-muted mb-3">
						Você possui uma assinatura para o plano
						<strong>{{ checkPlanPending().name }}</strong>
						aguardando pagamento. O que você gostaria de fazer?
					</p>
					<div class="d-flex flex-column gap-2">
						<a href="/plans/status" class="btn btn-primary d-grid">
							<i class="bi bi-hourglass-split me-2"></i>
							Verificar Status do Pagamento
						</a>
						<form action="/plans/cancel-pending" method="post" class="d-grid">
							{{csrf.field|raw }}
							<button type="submit" class="btn btn-outline-secondary">
								<i class="bi bi-x-circle me-2"></i>
								Cancelar e Escolher Outro Plano
							</button>
						</form>
					</div>
					{% else %}
					<p class="text-muted mb-3">
						Seu plano atual possui algumas limitações. Para uma melhor experiência, considere atualizar para um plano
						com
						mais recursos.
					</p>
					<div class="d-flex flex-column gap-2">
						<a href="/plans" class="btn btn-outline-primary">
							<i class="bi bi-arrow-up-circle me-2"></i>
							Conhecer Planos
						</a>
					</div>
					{% endif %}
				</div>

				{# Footer do Modal #}
				<div class="modal-footer border-0">
					<button type="button" class="btn btn-link btn-sm text-muted" data-bs-dismiss="modal">
						Continuar com o plano atual
					</button>
				</div>
			</div>
		</div>
	</div>

	{% endif %}

	<h1 class="mb-4">Painel do Prestador</h1>

	<div class="row">
		<!-- Resumo Financeiro -->
		<div class="col-12 col-md-6 mb-4">
			<div class="card hover-card mb-4">
				<div class="card-header bg-primary">
					<div class="d-flex justify-content-between align-items-center">
						<h5 class="card-title mb-0">Resumo Financeiro</h5>
						<span class="badge bg-light text-primary">
							{{ "now"|month_year_pt }}
						</span>
					</div>
				</div>
				<div class="card-body">
					{# Faturamento Mensal #}
					<div class="d-flex justify-content-between align-items-center mb-3">
						<div>
							<h6 class="mb-0">Faturamento Mensal</h6>
							<small class="text-muted">Total aprovado/pago</small>
						</div>
						<div class="text-end">
							<h5 class="mb-0 text-success">
								R$ {{ financial_summary.monthly_revenue|number_format(2, ',', '.') }}
							</h5>
						</div>
					</div>

					{# Orçamentos Pendentes #}
					<div class="d-flex justify-content-between align-items-center mb-3">
						<div>
							<h6 class="mb-0">Orçamentos Pendentes</h6>
							<small class="text-muted">
								{{ financial_summary.pending_budgets.count }} orçamento(s)
							</small>
						</div>
						<div class="text-end">
							<h5 class="mb-0 text-warning">
								R$ {{ financial_summary.pending_budgets.total|number_format(2, ',', '.') }}
							</h5>
						</div>
					</div>

					{# Pagamentos Atrasados #}
					<div class="d-flex justify-content-between align-items-center mb-3">
						<div>
							<h6 class="mb-0">Pagamentos Atrasados</h6>
							<small class="text-muted">
								{{ financial_summary.overdue_payments.count }} pagamento(s)
							</small>
						</div>
						<div class="text-end">
							<h5 class="mb-0 text-danger">
								R$ {{ financial_summary.overdue_payments.total|number_format(2, ',', '.') }}
							</h5>
						</div>
					</div>

					{# Projeção Próximo Mês #}
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<h6 class="mb-0">Projeção Próximo Mês</h6>
							<small class="text-muted">{{ "first day of next month"|date("M/Y") }}</small>
						</div>
						<div class="text-end">
							<h5 class="mb-0 text-info">
								R$ {{ financial_summary.next_month_projection|number_format(2, ',', '.') }}
							</h5>
						</div>
					</div>

					{# Gráfico ou Indicadores #}
					<div class="mt-4">
						{% set monthly_revenue = financial_summary.monthly_revenue|default(0) %}
						{% set pending_total = financial_summary.pending_budgets.total|default(0) %}
						{% set total = monthly_revenue + pending_total %}

						{% if total > 0 %}
						<div class="progress" style="height: 10px;">
							{% set total = financial_summary.monthly_revenue + financial_summary.pending_budgets.total %}
							{% set approved_percentage = calculate_percentage(financial_summary.monthly_revenue, total) %}

							<div class="progress-bar bg-success" role="progressbar" style="width: {{ approved_percentage }}%"
								aria-valuenow="{{ approved_percentage }}" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip"
								title="Faturado: {{ approved_percentage }}%">
							</div>

							<div class="progress-bar bg-warning" role="progressbar" style="width: {{ pending_percentage }}%"
								aria-valuenow="{{ pending_percentage }}" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip"
								title="Pendente: R$ {{ pending_total|number_format(2, ',', '.') }} ({{ pending_percentage }}%)">
							</div>
						</div>
						<div class="d-flex justify-content-between mt-1">
							<small class="text-success">{{ approved_percentage }}% Faturado</small>
							<small class="text-warning">{{ pending_percentage }}% Pendente</small>
						</div>
						{% else %}
						<div class="alert alert-light text-center mb-0">
							<i class="bi bi-info-circle me-2"></i>
							Nenhum valor registrado para o período
						</div>
						{% endif %}
					</div>

				</div>
				<div class="card-footer bg-light">
					<div class="d-flex justify-content-between align-items-center">
						<small class="text-muted">Última atualização: {{ "now"|date("d/m/Y H:i") }}</small>
						<a href="/provider/reports/financial" class="btn btn-sm btn-outline-primary">
							<i class="bi bi-graph-up me-1"></i>Ver Relatório Completo
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Atividades Recentes -->
		<div class="col-md-6 mb-4">
			<div class="card border-0 shadow-sm hover-card">
				<div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
					<h5 class="card-title mb-0">
						<i class="bi bi-activity me-2"></i>Atividades Recentes
					</h5>
					<span class="badge bg-white text-info rounded-pill px-3">{{ activities|length }}</span>
				</div>

				<div class="card-body p-0">
					{% if activities is empty %}
					<div class="text-center py-1">
						<i class="bi bi-calendar-x text-muted" style="font-size: var(--icon-size-xl);"></i>
						<p class="text-muted mt-3 mb-0">Nenhuma atividade recente encontrada</p>
						<small class="small-text">As atividades aparecerão aqui conforme você utiliza o sistema</small>
					</div>
					{% else %}
					<div class="activity-timeline" style="max-height: 400px; overflow-y: auto;">
						{% for activity in activities %}
						<div class="activity-item p-3 {% if not loop.last %}border-bottom{% endif %}">
							<div class="d-flex">
								<!-- Ícone com círculo colorido -->
								<div class="me-3">
									<div class="activity-icon-circle">
										<i class="bi {{ translations.actionIcons[activity.action_type]|default('bi-clock-history') }}
			                                   {{ translations.textColors[activity.action_type]|default('text-primary') }}"></i>
									</div>
								</div>
								<!-- Conteúdo da atividade -->
								<div class="flex-grow-1">
									<div class="d-flex justify-content-between align-items-center mb-1">
										<span class="fw-semibold">
											{{ translations.descriptionTranslation[activity.action_type]|default(activity.action_type) }}
										</span>
										<span class="badge rounded-pill activity-badge-{{ activity.action_type|split('_')|last }}">
											{{ activity.created_at|time_diff }}
										</span>
									</div>

									<p class="mb-1 text-truncate small-text" style="max-width: 100%;" data-bs-toggle="tooltip"
										title="{{ activity.description }}">
										Descrição: {{ activity.description }}
									</p>

									<div class="d-flex align-items-center">
										<small class="small-text"> por {{ activity.user_name }}</small>
									</div>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
					{% endif %}
				</div>

				{% if activities|length >= 5 %}
				<div class="card-footer bg-light d-flex justify-content-between align-items-center">
					<small class="small-text">Mostrando {{ activities|length }} de {{
						total_activities|default(activities|length)
						}}</small>
					<a href="/activities" class="btn btn-sm btn-outline-info">
						<i class="bi bi-clock-history me-1"></i>Ver Histórico Completo
					</a>
				</div>
				{% endif %}
			</div>
		</div>




	</div>

	<div class="row">
		<!-- Ações Rápidas -->
		<div class="col-md-12 mb-4">
			<h3>Ações Rápidas</h3>
			<div class="d-flex flex-wrap">
				<a href="/provider/budgets/create" class="btn btn-primary me-2 mb-2">Criar Novo Orçamento</a>
				<a href="/provider/reports" class="btn btn-info me-2 mb-2">Ver Relatórios</a>
			</div>
		</div>
	</div>

	<div class="row">
		<!-- Orçamentos Recentes -->
		{% set statusClass = {
		'NOVO': 'bg-primary',
		'EM PROGRESSO': 'bg-warning',
		'COMPLETADO': 'bg-success',
		'CANCELADO': 'bg-danger'
		} %}
		<div class="col-md-6 mb-4">
			<div class="card hover-card mb-4">
				<div class="card-header bg-success">
					<h5 class="card-title mb-0">Orçamentos Recentes</h5>
				</div>
				<div class="card-body">
					<ul class="list-group">
						{% if budgets is empty %}
						<li class="list-group-item text-center text-muted">
							Nenhum orçamento recente encontrado
						</li>
						{% else %}
						{% for budget in budgets %}
						<li class="list-group-item border-top">
							<div class="d-flex justify-content-between">
								<div class="d-flex flex-column flex-grow-1">
									{# Informações do Cliente #}
									<div class="d-flex flex-column flex-md-row justify-content-between gap-2">
										<div class="d-flex align-items-center flex-wrap gap-2">
											<div class="btn-group btn-group-sm">
												<a href="/provider/budgets/show/{{ budget.code}}" class="btn btn-warning">
													<i class="bi bi-eye"></i>
												</a>
											</div>
											<span class="fw-bold">{{ budget.first_name}} {{ budget.last_name}}</span>
											<span class="badge bg-secondary">{{ budget.code}}</span>
											<span class="badge" style="background-color: {{budget.color}}">
												<i class="bi {{budget.icon}}"></i>
												{{budget.name}}
											</span>
										</div>
									</div>


									<div class="d-flex justify-content-between">
										{# Informações e Serviços - Lado Esquerdo #}
										<div class="flex-grow-1">
											<div class="mb-2">
												<small class="text-muted d-block">
													<i class="bi bi-file-text me-1"></i>
													{{ budget.description }}
												</small>
												<small class="text-muted d-block">
													<i class="bi bi-clock-history me-1"></i>
													Atualizado em: {{ budget.updated_at|date('d/m/Y') }}
												</small>
												<small class="text-muted d-block">
													<i class="bi bi-calendar-event me-1"></i>
													Vencimento em: {{ budget.due_date|date('d/m/Y') }}
												</small>
											</div>

											{% if budget.service_descriptions %}
											<div class="mt-2 budget-section">

												<div>
													<small class="text-muted d-block mb-1">
														<i class="bi bi-tools me-1"></i>Serviços ({{ budget.service_count }})
													</small>
													<div>
														{% set services = budget.service_descriptions|split(',') %}
														{% for service in services|slice(0, 2) %}
														<small class="d-block text-secondary">
															<i class="bi bi-dot"></i>{{ service }}
														</small>
														{% endfor %}
														{% if services|length > 2 %}
														<small class="d-block text-muted fst-italic">
															<i class="bi bi-plus-circle"></i> mais {{ services|length - 2 }} serviço(s)...
														</small>
														{% endif %}
													</div>
													<small class="text-success fw-bold d-block mt-1">
														Subtotal: R$ {{ budget.service_total|number_format(2, ',', '.') }}
													</small>
												</div>
											</div>
											{% endif %}
										</div>

										{# Total - Lado Direito #}
										<div class="ms-3 text-end">
											<span class="badge bg-success rounded-pill px-3 py-1">
												R$ {{ budget.total|number_format(2, ',', '.') }}
											</span>
										</div>
									</div>
								</div>
							</div>
						</li>

						{% endfor %}
						{% endif %}
					</ul>
				</div>
				<div class="card-footer d-flex justify-content-between align-items-center">
					<a href="/provider/budgets" class="btn btn-sm btn-outline-success">
						<i class="bi bi-list-ul me-1"></i>Ver Todos
					</a>
					<small class="text-muted">
						{{ budgets|length }} orçamento(s) recente(s)
					</small>
				</div>
			</div>
		</div>

		<!-- Próximos Compromissos -->
		<div class="col-md-6 mb-4">
			<div class="card hover-card mb-4">
				<div class="card-header bg-warning">
					<h5 class="card-title mb-0">Próximos Compromissos</h5>
				</div>
				<div class="card-body">
					<ul class="list-group">
						<li class="list-group-item">
							<strong>15/06/2023</strong>
							- Reunião com Cliente A
						</li>
						<li class="list-group-item">
							<strong>18/06/2023</strong>
							- Entrega do Projeto B
						</li>
					</ul>
				</div>
				<div class="card-footer">
					<a href="/agenda" class="btn btn-sm btn-outline-warning">Ver Agenda Completa</a>
				</div>
			</div>
		</div>
	</div>
</div>

{% endblock %}


{# Bloco de scripts #}
{% block scripts %}
<script>
	document.addEventListener( 'DOMContentLoaded', function () {
		var myModal = new bootstrap.Modal( document.getElementById( 'planAlertModal' ) );
		myModal.show();
	} );
</script>
{% endblock %}
