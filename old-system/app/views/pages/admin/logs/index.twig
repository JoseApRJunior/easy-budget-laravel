{% extends "layout.twig" %}

{% block content %}
<div class="container-fluid py-4">
  <!-- CabeÃ§alho -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      <i class="bi bi-file-earmark-text me-2"></i>Logs do Sistema
    </h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/admin">Dashboard Admin</a></li>
        <li class="breadcrumb-item active">Logs</li>
      </ol>
    </nav>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Visualizador de Logs</h5>
      <form id="log-date-filter" method="GET" action="/admin/logs" class="d-flex align-items-center">
        <label for="log-date" class="form-label me-2 mb-0">Selecionar Data:</label>
        <select name="date" id="log-date" class="form-select form-select-sm" style="width: auto;"
          onchange="this.form.submit()">
          {% for date in logDates %}
          <option value="{{ date }}" {% if date==selectedDate %}selected{% endif %}>
            {{ date|date("d/m/Y") }}
          </option>
          {% endfor %}
          {% if not selectedDate in logDates %}
          <option value="{{ selectedDate }}" selected>{{ selectedDate|date("d/m/Y") }} (Vazio)</option>
          {% endif %}
        </select>
        <noscript><button type="submit" class="btn btn-primary btn-sm ms-2">Ver</button></noscript>
      </form>
    </div>
    <div class="card-body">
      {% if logs %}
      <div class="accordion" id="logAccordion">
        {% for log in logs %}
        {% set level_class = {
        'ERROR': 'danger',
        'WARNING': 'warning',
        'INFO': 'info',
        'DEBUG': 'secondary'
        }[log.level] | default('light') %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-{{ loop.index }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false"
              aria-controls="collapse-{{ loop.index }}">
              <span class="badge bg-{{ level_class }} me-3">{{ log.level }}</span>
              <span class="fw-bold me-3">{{ log.datetime }}</span>
              <span class="text-truncate">{{ log.message }}</span>
            </button>
          </h2>
          <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse"
            aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#logAccordion">
            <div class="accordion-body bg-light">
              {% if log.is_html %}
              <iframe srcdoc="{{ log.details }}"
                style="width: 100%; height: 500px; border: 1px solid #ccc; border-radius: 5px;"></iframe>
              {% else %}
              <pre
                style="background-color: #2d2d2d; color: #f1f1f1; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word;">{{ log.message }}<br>{{ log.details|trim ?: 'Nenhum detalhe adicional.' }}</pre>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info text-center">
        Nenhum log encontrado.
      </div>
      {% endif %}
    </div>
    <div class="card-footer bg-transparent border-0">
      <p class="text-muted small mb-0">Exibindo logs do arquivo:
        <code>storage/logs/app-{{ selectedDate }}.log</code>
      </p>
    </div>
  </div>
</div>
{% endblock %}
