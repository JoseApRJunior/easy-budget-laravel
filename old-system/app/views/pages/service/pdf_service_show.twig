{% extends "layout.twig" %}

{% block content %}
<div class="container-fluid py-1">
	<!-- Cabeçalho da página -->
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1 class="h3 mb-0">
			<i class="bi bi-tools me-2"></i>Detalhes do Serviço
		</h1>
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb mb-0">
				<li class="breadcrumb-item"><a href="/provider">Dashboard</a></li>
				<li class="breadcrumb-item"><a href="/provider/services">Serviços</a></li>
				<li class="breadcrumb-item active">{{ service.code }}</li>
			</ol>
		</nav>
	</div>

	<!-- Informações do Serviço -->
	<div class="row g-4 mb-4">
		<!-- Card de Informações Básicas -->
		<div class="col-md-8">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-header bg-transparent">
					<h5 class="card-title mb-0">
						<i class="bi bi-info-circle me-2"></i>Informações do Serviço
					</h5>
				</div>
				<div class="card-body">
					<div class="row g-3">
						<div class="col-md-6">
							<div class="d-flex">
								<div class="text-muted me-2">Código:</div>
								<div class="fw-semibold">{{ service.code }}</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex">
								<div class="text-muted me-2">Data de Criação:</div>
								<div class="fw-semibold">{{ service.created_at|date('d/m/Y H:i') }}</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex">
								<div class="text-muted me-2">Cliente:</div>
								<div class="fw-semibold">{{ service.customer_name }}</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex">
								<div class="text-muted me-2">Orçamento:</div>
								<div class="fw-semibold">
									<a href="/provider/budgets/show/{{ service.budget_code }}">{{ service.budget_code }}</a>
									{{budget|status_badge|raw}}
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex">
								<div class="text-muted me-2">Categoria:</div>
								<div class="fw-semibold">{{ service.category_name }}</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex">
								<div class="text-muted me-2">Vencimento:</div>
								<div
									class="fw-semibold {% if service.due_date|date('Y-m-d') < 'now'|date('Y-m-d') %}text-danger{% endif %}">
									{{ service.due_date|date('d/m/Y') }}
								</div>
							</div>
						</div>

						<div class="col-12">
							<div class="d-flex">
								<div class="text-muted me-2">Status:</div>
								<div>
									{{service|status_badge|raw}}
								</div>
							</div>
						</div>
						<!-- Detalhes do Agendamento -->
						{% if latest_schedule %}
						<div class="col-12 mt-3">
							<div class="card border-light-subtle">
								<div class="card-header bg-light-subtle">
									<h6 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Detalhes do Agendamento</h6>
								</div>
								<div class="card-body">
									<div class="row">
										<div class="col-md-6">
											<div class="text-muted small">Início do Serviço</div>
											<div class="fw-semibold">{{ latest_schedule.start_date_time|date('d/m/Y H:i') }}</div>
										</div>
										<div class="col-md-6">
											<div class="text-muted small">Local</div>
											<div class="fw-semibold">{{ latest_schedule.location|default('Não informado') }}</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						{% endif %}

						<div class="col-12 mt-3">
							<hr>
						</div>
						<div class="col-12">
							<div class="text-muted mb-2">Descrição Original do Serviço:</div>
							<div class="p-3 rounded bg-light">{{ service.description|nl2br }}</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Card de Resumo Financeiro -->
		<div class="col-md-4">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-header bg-transparent">
					<h5 class="card-title mb-0">
						<i class="bi bi-currency-dollar me-2"></i>Resumo Financeiro
					</h5>
				</div>
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<div class="text-muted">Total do Serviço:</div>
						<div class="h4 mb-0 text-success">R$ {{ service.total|number_format(2, ',', '.') }}</div>
					</div>
					<div class="d-flex justify-content-between align-items-center mb-3">
						<div class="text-muted">Quantidade de Itens:</div>
						<div class="fw-semibold">{{ serviceItems|length }}</div>
					</div>

					<!-- Barra de progresso do serviço -->
					<div class="mb-4">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<span class="text-muted">Progresso do serviço:</span>
						</div>
						<div class="progress" style="height: 10px;">
							<div class="progress-bar bg-{{ service.status_slug|status_color_class }}" role="progressbar"
								style="width: {{ service.status_slug|status_progress }}%;"
								aria-valuenow="{{ service.status_slug|status_progress }}" aria-valuemin="0" aria-valuemax="100"
								data-bs-toggle="tooltip" title="{{ service.status_name }}">
							</div>
						</div>
						<small class="text-muted mt-1 d-block">
							{% if service.status_slug == 'SCHEDULED' %}
							Serviço agendado, aguardando início
							{% elseif service.status_slug == 'PREPARING' %}
							Preparando para execução
							{% elseif service.status_slug == 'IN_PROGRESS' %}
							Serviço em andamento
							{% elseif service.status_slug == 'ON_HOLD' %}
							Serviço temporariamente em espera
							{% elseif service.status_slug == 'COMPLETED' %}
							Serviço concluído com sucesso
							{% elseif service.status_slug == 'PARTIAL' %}
							Serviço parcialmente concluído
							{% elseif service.status_slug == 'CANCELLED' %}
							Serviço cancelado
							{% elseif service.status_slug == 'NOT_PERFORMED' %}
							Serviço não realizado
							{% endif %}
						</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Itens do Serviço -->
	<div class="card border-0 shadow-sm mb-4">
		<div class="card-header bg-transparent">
			<h5 class="card-title mb-0">
				<i class="bi bi-list-check me-2"></i>Itens do Serviço
			</h5>
		</div>
		<div class="card-body p-0">
			<div class="table-responsive">
				<table id="results-table" class="table table-hover align-middle mb-0">
					<thead>
						<tr>
							<th style="width: 5%">#</th>
							<th style="width: 10%">Código</th>
							<th style="width: 40%">Produto</th>
							<th style="width: 15%">Valor Unitário</th>
							<th style="width: 10%">Quantidade</th>
							<th style="width: 20%">Total</th>
						</tr>
					</thead>
					<tbody>
						{# Será preenchido via JavaScript #}
					</tbody>
					<tfoot>
						<tr>
							<td colspan="5" class="text-end fw-bold">Total do Serviço:</td>
							<td class="fw-bold text-success">R$ {{ service.total|number_format(2, ',', '.') }}</td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
		{# Paginação #}
		{% include 'partials/components/table_paginator.twig' %}
	</div>

	<!-- Botões de Ação -->
	<div class="d-flex justify-content-between mt-4">
		<a href="/provider/services" class="btn btn-outline-secondary">
			<i class="bi bi-arrow-left me-2"></i>Voltar
		</a>
		<small class="text-muted">
			Última atualização: {{ service.updated_at|date('d/m/Y H:i') }}
		</small>
		{# Botões de Ação para o Serviço - Apenas se não for um status final #}
		{% if service.status_slug not in ['CANCELLED', 'COMPLETED', 'PARTIAL', 'NOT_PERFORMED', 'EXPIRED'] %}
		<div class="d-flex gap-2">
			{% if service.status_slug in ['DRAFT','ON_HOLD'] and budget.status_slug in ['DRAFT','REJECTED'] %}
			<a href="/provider/services/update/{{ service.code }}" class="btn btn-primary">
				<i class="bi bi-pencil me-2"></i>Editar
			</a>
			{% endif %}

			{% if service.status_slug == 'PENDING' and budget.status_slug == 'APPROVED' %}
			<button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#scheduleModal">
				<i class="bi bi-calendar-check me-2"></i>Agendar
			</button>
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="PREPARING" data-title="Preparar Serviço" data-button-class="btn-warning"
				data-message="Tem certeza que deseja marcar o serviço {{ service.code }} como em preparação?">
				<i class="bi bi-tools me-2"></i>Preparar
			</button>
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="ON_HOLD" data-title="Colocar em Espera" data-button-class="btn-warning"
				data-message="Tem certeza que deseja colocar o serviço {{ service.code }} em espera?">
				<i class="bi bi-pause-circle me-2"></i>Em Espera
			</button>
			{% endif %}

			{% if service.status_slug == 'SCHEDULED' and budget.status_slug ==
			'APPROVED'%}
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="PREPARING" data-title="Preparar Serviço" data-button-class="btn-warning"
				data-message="Tem certeza que deseja preparar o serviço {{ service.code }}?">
				<i class="bi bi-tools me-2"></i>Preparar
			</button>
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="ON_HOLD" data-title="Colocar em Espera" data-button-class="btn-warning"
				data-message="Tem certeza que deseja colocar o serviço {{ service.code }} em espera?">
				<i class="bi bi-pause-circle me-2"></i>Em Espera
			</button>
			<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="NOT_PERFORMED" data-title="Não Realizado" data-button-class="btn-danger"
				data-message="Tem certeza que deseja não realizar o serviço {{ service.code }}?">
				<i class="bi bi-x-circle me-2"></i>Não Realizar
			</button>
			{% endif %}

			{% if service.status_slug == 'PREPARING' and budget.status_slug ==
			'APPROVED'%}
			<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="IN_PROGRESS" data-title="Iniciar Serviço" data-button-class="btn-success"
				data-message="Tem certeza que deseja iniciar o serviço {{ service.code }}?">
				<i class="bi bi-play-circle me-2"></i>Iniciar
			</button>
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="ON_HOLD" data-title="Colocar em Espera" data-button-class="btn-warning"
				data-message="Tem certeza que deseja colocar o serviço {{ service.code }} em espera?">
				<i class="bi bi-pause-circle me-2"></i>Em Espera
			</button>
			<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="NOT_PERFORMED" data-title="Não Realizado" data-button-class="btn-danger"
				data-message="Tem certeza que deseja não realizar o serviço {{ service.code }}?">
				<i class="bi bi-x-circle me-2"></i>Não Realizar
			</button>
			{% endif %}

			{% if service.status_slug == 'IN_PROGRESS' and budget.status_slug == 'APPROVED' %}
			<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="PARTIAL" data-title="Concluir Serviço Parcialmente" data-button-class="btn-success"
				data-message="Tem certeza que deseja concluir o serviço {{ service.code }} parcialmente?">
				<i class="bi bi-check-circle me-2"></i>Concluir Parcialmente
			</button>
			<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="COMPLETED" data-title="Concluir Serviço" data-button-class="btn-success"
				data-message="Tem certeza que deseja concluir o serviço {{ service.code }}?">
				<i class="bi bi-check-circle me-2"></i>Concluir
			</button>
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="ON_HOLD" data-title="Colocar em Espera" data-button-class="btn-warning"
				data-message="Tem certeza que deseja colocar o serviço {{ service.code }} em espera?">
				<i class="bi bi-pause-circle me-2"></i>Em Espera
			</button>
			{% endif %}

			{% if (service.status_slug == 'SCHEDULING' or service.status_slug == 'ON_HOLD') and budget.status_slug ==
			'APPROVED'
			%}
			<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="NOT_PERFORMED" data-title="Não Realizado" data-button-class="btn-danger"
				data-message="Tem certeza que deseja não realizar o serviço {{ service.code }}?">
				<i class="bi bi-x-circle me-2"></i>Não Realizar
			</button>
			<button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#scheduleModal">
				<i class="bi bi-calendar-check me-2"></i>Agendar
			</button>
			{% endif %}
			<button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="CANCELLED" data-title="Cancelar Serviço" data-button-class="btn-danger"
				data-message="Tem certeza que deseja cancelar o serviço {{ service.code }}?">
				<i class="bi bi-x-circle me-2"></i>Cancelar
			</button>
		</div>
		{% else %}
		{# Se o serviço estiver em um status final, exibe apenas os botões de impressão e geração de fatura #}
		<div class="d-flex gap-2">
			{% if service.status_slug in ['CANCELLED', 'NOT_PERFORMED', 'EXPIRED'] %}
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#actionModal"
				data-action="DRAFT" data-title="Reativar Serviço" data-button-class="btn-warning"
				data-message="Tem certeza que deseja reativar o serviço {{ service.code }}?">
				<i class="bi bi-arrow-clockwise me-2"></i>Reativar
			</button>
			{% endif %}
			{% if service.status_slug == 'COMPLETED' or service.status_slug == 'PARTIAL' %}
			<a href="/provider/invoices/create/{{ service.code }}" class="btn btn-success ms-2">
				<i class="bi bi-receipt me-2"></i>Gerar Fatura
			</a>
			{% endif %}
			<a href="/provider/services/print/{{ service.code }}" class="btn btn-outline-primary" target="_blank">
				<i class="bi bi-printer me-2"></i>Imprimir Serviço
			</a>
		</div>
		{% endif %}
	</div>
</div>

<!-- Modal Reutilizável para Ações de Serviço -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="actionModalLabel"></h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p id="actionModalMessage"></p>
				<p class="text-danger mt-2" id="actionModalWarning" style="display: none;">
					<strong>Atenção:</strong> Esta ação não pode ser desfeita.
				</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Voltar</button>
				<form id="actionForm" action="" method="POST">
					{{ csrf.field|raw }}
					<input type="hidden" name="service_id" value="{{ service.id }}">
					<input type="hidden" name="service_code" value="{{ service.code }}">
					<input type="hidden" name="current_status_id" value="{{ service.status_id }}">
					<input type="hidden" name="current_status_name" value="{{ service.status_name }}">
					<input type="hidden" name="current_status_slug" value="{{ service.status_slug }}">
					<input type="hidden" name="new_due_date" value="">
					<input type="hidden" name="start_date_time" value="">
					<input type="hidden" name="location">
					<input type="hidden" name="action" id="formActionInput" value="">
					<button type="submit" class="btn" id="actionConfirmButton">Confirmar</button>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- Modal para Agendamento de Serviço -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form id="scheduleForm" action="/provider/services/change-status" method="POST">
				<div class="modal-header">
					<h5 class="modal-title" id="scheduleModalLabel"><i class="bi bi-calendar-check me-2"></i>Agendar Serviço</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>Preencha os detalhes abaixo para agendar o serviço <strong>{{ service.code }}</strong>.</p>

					{{ csrf.field|raw }}
					<input type="hidden" name="service_id" value="{{ service.id }}">
					{{ csrf.field|raw }}
					<input type="hidden" name="service_id" value="{{ service.id }}">
					<input type="hidden" name="service_code" value="{{ service.code }}">
					<input type="hidden" name="current_status_id" value="{{ service.status_id }}">
					<input type="hidden" name="current_status_name" value="{{ service.status_name }}">
					<input type="hidden" name="current_status_slug" value="{{ service.status_slug }}">
					<input type="hidden" name="action" value="SCHEDULED">

					<div class="mb-3">
						<label for="new_due_date" class="form-label">Nova Data de Vencimento</label>
						<input type="date" class="form-control" id="new_due_date" name="new_due_date"
							value="{{ service.due_date|date('Y-m-d') }}" required>
						<small class="form-text text-muted">A data final para a conclusão do serviço.</small>
					</div>

					<div class="mb-3">
						<label for="start_date_time" class="form-label">Data e Hora de Início</label>
						<input type="datetime-local" class="form-control" id="start_date_time" name="start_date_time" value="{{ "
							now"|date("Y-m-d\\TH:i") }}" required>
						<small class="form-text text-muted">Quando o serviço será iniciado.</small>
					</div>

					<div class="mb-3">
						<label for="location" class="form-label">Local de Execução</label>
						<textarea class="form-control" id="location" name="location" rows="3"
							placeholder="Ex: Rua Exemplo, 123, Bairro, Cidade - SP"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-info">Confirmar Agendamento</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ parent() }}
<script src="/assets/js/modules/table-paginator.js"></script>

<script>
	document.addEventListener( 'DOMContentLoaded', function () {
		const actionModal = document.getElementById( 'actionModal' );
		const scheduleModal = document.getElementById( 'scheduleModal' );
		let serviceItems = JSON.parse( '{{ serviceItems | json_encode | e("js") }}' );

		// Inicializar tooltips
		var tooltipTriggerList = [].slice.call( document.querySelectorAll( '[data-bs-toggle="tooltip"]' ) )
		var tooltipList = tooltipTriggerList.map( function ( tooltipTriggerEl ) {
			return new bootstrap.Tooltip( tooltipTriggerEl )
		} );

		// Adicionar índices aos itens
		serviceItems = serviceItems.map( ( item, index ) => ( {
			...item,
			index: index
		} ) );
		// Função para formatar cada linha da tabela de serviços
		function formatServiceRow( item ) {
			return `
             <tr>
                <td>${item.index + 1}</td>
                <td>${item.code}</td>
                <td>${item.name}</td>
                <td>R$ ${parseFloat( item.unit_value ).toLocaleString( 'pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 } )}</td>
                <td>${item.quantity}</td>
                <td>R$ ${( parseFloat( item.unit_value ) * item.quantity ).toLocaleString( 'pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 } )}</td>
            </tr>`;
		}

		// Inicializa o paginador de tabela apenas se houver itens
		if ( serviceItems.length > 0 ) {
			const servicePaginator = new TablePaginator( {
				tableId: "results-table",
				paginationId: "pagination",
				infoId: "pagination-info",
				itemsPerPage: 5,
				colSpan: 6,
				formatRow: formatServiceRow
			} );

			// Atualiza a tabela com os dados extraídos
			servicePaginator.updateTable( serviceItems );
		}

		// Lógica para o modal de ação reutilizável
		if ( actionModal ) {
			actionModal.addEventListener( 'show.bs.modal', function ( event ) {
				const button = event.relatedTarget;
				const action = button.getAttribute( 'data-action' );
				const title = button.getAttribute( 'data-title' );
				const message = button.getAttribute( 'data-message' );
				const buttonClass = button.getAttribute( 'data-button-class' ) || 'btn-primary';

				const modalTitle = actionModal.querySelector( '.modal-title' );
				const modalMessage = actionModal.querySelector( '#actionModalMessage' );
				const formActionInput = actionModal.querySelector( '#formActionInput' );
				const actionForm = actionModal.querySelector( '#actionForm' );
				const confirmButton = actionModal.querySelector( '#actionConfirmButton' );
				const modalWarning = actionModal.querySelector( '#actionModalWarning' );

				modalTitle.textContent = title;
				modalMessage.innerHTML = message; // Usar innerHTML se a mensagem contiver HTML
				formActionInput.value = action; // Define o valor do input hidden 'action' no formulário
				actionForm.action = `/provider/services/change-status`; // Rota base para mudança de status
				modalWarning.style.display = ( action === 'CANCELLED' || action === 'DRAFT' ) ? 'block' : 'none';

				confirmButton.className = 'btn ' + buttonClass;
			} );
		}
		// Lógica para o novo modal de agendamento
		if ( scheduleModal ) {
			const newDueDateInput = scheduleModal.querySelector( '#new_due_date' );
			const startDateTimeInput = scheduleModal.querySelector( '#start_date_time' );
			const today = new Date().toISOString().split( 'T' )[0];

			// Define a data mínima para o vencimento como hoje.
			newDueDateInput.setAttribute( 'min', today );

			// Define a data/hora mínima para o início do serviço como o momento atual (local).
			const now = new Date();
			const year = now.getFullYear();
			const month = String( now.getMonth() + 1 ).padStart( 2, '0' );
			const day = String( now.getDate() ).padStart( 2, '0' );
			const hours = String( now.getHours() ).padStart( 2, '0' );
			const minutes = String( now.getMinutes() ).padStart( 2, '0' );
			const localDateTimeMin = `${year}-${month}-${day}T${hours}:${minutes}`;
			startDateTimeInput.setAttribute( 'min', localDateTimeMin );
		}
	} );
</script>
{% endblock %}
