{% extends "layout.twig" %}

{% block content %}
<div class="container mt-4">
	<h1 class="mb-4">
		Editar Serviço
	</h1>
	<div class="row mb-4">
		<form id="edit-service-form" action="/provider/services/edit/{{ service.id }}" method="POST"
			enctype="multipart/form-data">
			{{ csrf.field|raw }}

			<div class="card shadow-sm">
				<div class="card-body">
					<div class="row">
						<div class="col-md-3">
							<div class="mb-3">
								<label for="code" class="form-label">
									Código de Orçamento:
								</label>
								<input type="text" id="code" name="code" class="form-control" readonly value="{{ service.code }}">
								{{ flash('code') | raw }}
							</div>
						</div>
						<div class="col-md-3">
							<div class="mb-3">
								<label for="category" class="form-label">
									Categoria:
								</label>
								<select id="service-category" name="category" class="form-control">
									<option value="">Selecione uma categoria</option>
									{% for category in categories %}
									<option value="{{ category.id }}" {% if category.id==service.category_id %}selected{% endif %}>
										{{ category.name }}
									</option>
									{% endfor %}
								</select>
								{{ flash('category') | raw }}
							</div>
						</div>
						<div class="col-md-3">
							<div class="mb-3">
								<label for="status" class="form-label">
									Status:
								</label>
								<select id="service-status" name="status" class="form-control">
									<option value="">Selecione um status</option>
									{% for status in statuses %}
									<option value="{{ status.id }}" {% if status.id==service.status_id %}selected{% endif %}>
										{{ status.name }}
									</option>
									{% endfor %}
								</select>
								{{ flash('status') | raw }}
							</div>
						</div>
						<div class="col-md-3">
							<div class="mb-4">
								<label for="due-date" class="form-label">
									Previsão de Vencimento:
								</label>
								<input id="due-date" name="due_date" class="form-control" type="date"
									value="{{ service.due_date|date('Y-m-d') }}" />
								{{ flash('due_date')|raw }}
							</div>
						</div>
						<div class="col-md-12">
							<div class="mb-3">
								<label for="description" class="form-label">
									Descrição
								</label>
								<textarea class="form-control" id="description" name="description" rows="2"
									maxlength="250">{{ service.description }}</textarea>
								{{ flash('description') | raw }}
								<div class="text-muted" id="char-count">
									Caracteres restantes:
									<span id="char-count-value">
										{{ 250 - (service.description|length) }}
									</span>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<div class="mb-3">
								<label for="items-table" class="form-label">
									Itens do Serviço
								</label>
								<table id="items-table" class="table table-striped">
									<thead>
										<tr>
											<th class="col-md-1">#</th>
											<th class="col-md-1">Código</th>
											<th class="col-md-4">Nome</th>
											<th class="col-md-2">Valor Unitário</th>
											<th class="col-md-1">Quantidade</th>
											<th class="col-md-2">Total do Item</th>
											<th class="col-md-1">Ações</th>
										</tr>
									</thead>
									<tbody id="items-tbody">
										{% for item in service.items %}
										<tr data-item-id="{{ item.id }}">
											<td>{{ loop.index }}</td>
											<td>{{ item.code }}</td>
											<td>{{ item.name }}</td>
											<td>R$ {{ item.unit_value|number_format(2, ',', '.') }}</td>
											<td>{{ item.quantity }}</td>
											<td>R$ {{ (item.unit_value * item.quantity)|number_format(2, ',', '.') }}</td>
											<td>
												<button type="button" class="btn btn-sm btn-danger remove-item">
													<i class="bi bi-trash"></i>
												</button>
											</td>
										</tr>
										{% endfor %}
									</tbody>
									<tfoot>
										<tr>
											<td colspan="7" class="text-end">
												Total do Serviço:
												<span id="total-service">
													R$ {{ service.total|number_format(2, ',', '.') }}
												</span>
											</td>
										</tr>
									</tfoot>
								</table>
								<button id="add-item-button" type="button" class="btn btn-primary">
									<i class="bi bi-plus-lg"></i> Adicionar Item
								</button>
							</div>
						</div>
					</div>
					<div class="d-flex justify-content-between">
						<button type="button" onclick="history.back()" class="btn btn-secondary">
							<i class="bi bi-arrow-left"></i> Voltar
						</button>
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-check-lg"></i> Salvar Alterações
						</button>
					</div>
				</div>
			</div>
		</form>
	</div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/assets/css/pagination.css" />
{% endblock %}

{% block scripts %}
{{ parent() }}
<script>
	let service = JSON.parse( '{{ service|json_encode|e("js") }}' );
	let products = JSON.parse( '{{ products|json_encode|e("js") }}' );
</script>
<script src="/assets/js/service_edit.js"></script>
{% endblock %}
