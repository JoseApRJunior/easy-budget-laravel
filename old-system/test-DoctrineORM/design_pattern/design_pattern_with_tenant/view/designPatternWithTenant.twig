{#
/**
* Template Padrão WithTenant - Easy Budget
*
* PADRÕES IMPLEMENTADOS:
* ✅ Estrutura HTML5 semântica - Acessibilidade e SEO
* ✅ Bootstrap 5 responsivo - Design consistente
* ✅ Comentários em português brasileiro - Padrão do projeto
* ✅ Formulários acessíveis - Labels e validação client-side
* ✅ Campos obrigatórios de tenant - Controle multi-tenant
* ✅ Mensagens de feedback - Flash messages e validação
* ✅ Data attributes seguros - Substituição de onclick por event listeners
* ✅ JavaScript separado - Melhor manutenibilidade e debugging
* ✅ Validação de segurança client-side - Prevenção de manipulação cross-tenant
* ✅ Campos hidden para tenant_id - Validação automática
*
* BENEFÍCIOS:
* - Isolamento completo de dados entre tenants
* - Interface responsiva e moderna
* - Experiência do usuário consistente
* - Fácil manutenção e extensão
* - Acessibilidade web adequada
* - Segurança melhorada com validação multi-tenant
* - JavaScript não-obstrusivo com validações de segurança
* - Prevenção de manipulação cross-tenant no client-side
*
* MELHORIAS IMPLEMENTADAS:
* - ✅ Correção de conflitos JavaScript/Twig
* - ✅ Event listeners em vez de onclick inline
* - ✅ Escape adequado com html_attr para data attributes
* - ✅ Separação de responsabilidades (HTML/JS)
* - ✅ Validação de tentativas de manipulação cross-tenant
* - ✅ Logs de segurança client-side
*
* VARIÁVEIS ESPERADAS:
* - entity: Entidade para edição (opcional)
* - entities: Lista de entidades para índice (opcional)
* - tenant_id: ID do tenant (obrigatório para WithTenant)
* - action: Ação do formulário ('create' ou 'edit')
* - title: Título da página
*/
#}

{% extends "layout.twig" %}

{% block title %}{{ title|default('Padrões de Design WithTenant') }} - Easy Budget{% endblock %}

{% block styles %}
<style>
  .design-pattern-card {
    border-left: 4px solid #28a745;
    transition: transform 0.2s ease-in-out;
  }

  .design-pattern-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .tenant-badge {
    background: linear-gradient(45deg, #007bff, #28a745);
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-weight: 500;
  }

  .status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  .form-floating .form-control:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
  }

  .btn-group-actions {
    gap: 0.5rem;
  }

  .security-info {
    background: #f8f9fa;
    border-left: 4px solid #28a745;
    padding: 1rem;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  {# Cabeçalho da página #}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">{{ title|default('Padrões de Design WithTenant') }}</h1>
      <p class="text-muted mb-0">
        Gerenciamento de entidades com controle multi-tenant
        {% if tenant_id %}
        <span class="tenant-badge ms-2">Tenant {{ tenant_id }}</span>
        {% endif %}
      </p>
    </div>

    {% if action != 'create' and action != 'edit' %}
    <div>
      <a href="/admin/design-patterns-tenant/create" class="btn btn-success">
        <i class="fas fa-plus me-2"></i>Nova Entidade
      </a>
    </div>
    {% endif %}
  </div>

  {# Mensagens de feedback #}
  {% include "components/messages.twig" %}

  {# Conteúdo principal baseado na ação #}
  {% if action == 'create' or action == 'edit' %}
  {# Formulário de criação/edição #}
  {% include "design_pattern_with_tenant/form.twig" %}
  {% elseif action == 'show' %}
  {# Visualização de detalhes #}
  {% include "design_pattern_with_tenant/show.twig" %}
  {% else %}
  {# Lista de entidades (índice) #}
  {% include "design_pattern_with_tenant/index.twig" %}
  {% endif %}

</div>
{% endblock %}

{# Sub-template: Lista de entidades #}
{% macro entityIndex(entities, tenant_id) %}
<div class="row">
  {% if entities and entities|length > 0 %}
  {% for entity in entities %}
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card design-pattern-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h5 class="card-title mb-0">{{ entity.name }}</h5>
          <div class="d-flex gap-2">
            <span class="tenant-badge">T{{ entity.tenantId }}</span>
            <span class="badge status-badge {{ entity.active ? 'bg-success' : 'bg-secondary' }}">
              {{ entity.active ? 'Ativo' : 'Inativo' }}
            </span>
          </div>
        </div>

        {% if entity.description %}
        <p class="card-text text-muted small">
          {{ entity.description|slice(0, 100) }}{{ entity.description|length > 100 ? '...' : '' }}
        </p>
        {% endif %}

        <div class="small text-muted mb-3">
          <i class="fas fa-link me-1"></i>
          <code>{{ entity.slug }}</code>
        </div>

        <div class="small text-muted mb-3">
          <i class="fas fa-calendar me-1"></i>
          Criado em {{ entity.createdAt|date('d/m/Y H:i') }}
        </div>
      </div>

      <div class="card-footer bg-transparent">
        <div class="btn-group-actions d-flex justify-content-end">
          <a href="/admin/design-patterns-tenant/{{ entity.id }}" class="btn btn-sm btn-outline-primary" title="Visualizar">
            <i class="fas fa-eye"></i>
          </a>
          <a href="/admin/design-patterns-tenant/{{ entity.id }}/edit" class="btn btn-sm btn-outline-warning" title="Editar">
            <i class="fas fa-edit"></i>
          </a>
          <button type="button" class="btn btn-sm btn-outline-danger btn-delete" 
            data-entity-id="{{ entity.id }}"
            data-entity-name="{{ entity.name|escape('html_attr') }}" 
            data-tenant-id="{{ entity.tenantId }}"
            title="Excluir">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="col-12">
    <div class="text-center py-5">
      <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">Nenhuma entidade encontrada</h4>
      <p class="text-muted">
        Clique no botão "Nova Entidade" para começar.
        {% if tenant_id %}
        <br><small class="tenant-badge">Tenant {{ tenant_id }}</small>
        {% endif %}
      </p>
      <a href="/admin/design-patterns-tenant/create" class="btn btn-success">
        <i class="fas fa-plus me-2"></i>Criar Primeira Entidade
      </a>
    </div>
  </div>
  {% endif %}
</div>
{% endmacro %}

{# Sub-template: Formulário #}
{% macro entityForm(entity, action, tenant_id) %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-{{ action == 'create' ? 'plus' : 'edit' }} me-2"></i>
          {{ action == 'create' ? 'Nova Entidade' : 'Editar Entidade' }}
          {% if tenant_id %}
          <span class="tenant-badge ms-2">Tenant {{ tenant_id }}</span>
          {% endif %}
        </h5>
      </div>

      {# Informação de segurança #}
      {% if action == 'create' or action == 'edit' %}
      <div class="security-info">
        <small class="text-muted">
          <i class="fas fa-shield-alt me-1"></i>
          <strong>Segurança Multi-Tenant:</strong> 
          Esta entidade será associada exclusivamente ao tenant {{ tenant_id }}. 
          Não será visível ou acessível por outros tenants.
        </small>
      </div>
      {% endif %}

      <form method="POST"
        action="{{ action == 'create' ? '/admin/design-patterns-tenant' : '/admin/design-patterns-tenant/' ~ entity.id }}" 
        novalidate
        data-tenant-validation="{{ tenant_id }}">

        {% if action == 'edit' %}
        <input type="hidden" name="_method" value="PUT">
        {% endif %}

        {# Campo hidden para tenant_id - Validação de segurança #}
        <input type="hidden" name="tenant_id" value="{{ tenant_id }}" id="hidden-tenant-id">

        <div class="card-body">
          <div class="row">
            {# Campo Nome #}
            <div class="col-md-6 mb-3">
              <div class="form-floating">
                <input type="text" class="form-control" id="name" name="name" value="{{ entity.name|default('') }}"
                  placeholder="Nome da entidade" required maxlength="100">
                <label for="name">Nome da Entidade *</label>
                <div class="invalid-feedback">
                  O nome é obrigatório e deve ter entre 2 e 100 caracteres.
                </div>
              </div>
            </div>

            {# Campo Slug #}
            <div class="col-md-6 mb-3">
              <div class="form-floating">
                <input type="text" class="form-control" id="slug" name="slug" value="{{ entity.slug|default('') }}"
                  placeholder="slug-da-entidade" pattern="^[a-z0-9-]+$" maxlength="100">
                <label for="slug">Slug (URL amigável)</label>
                <div class="form-text">
                  Deixe vazio para gerar automaticamente. Único dentro do tenant {{ tenant_id }}.
                </div>
                <div class="invalid-feedback">
                  O slug deve conter apenas letras minúsculas, números e hífens.
                </div>
              </div>
            </div>
          </div>

          {# Campo Descrição #}
          <div class="mb-3">
            <div class="form-floating">
              <textarea class="form-control" id="description" name="description" placeholder="Descrição da entidade"
                style="height: 100px" maxlength="500">{{ entity.description|default('') }}</textarea>
              <label for="description">Descrição</label>
              <div class="form-text">
                Descrição opcional da entidade (máximo 500 caracteres).
              </div>
            </div>
          </div>

          {# Campo Status Ativo #}
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="active" name="active" value="1" {{
                (entity.active|default(true)) ? 'checked' : '' }}>
              <label class="form-check-label" for="active">
                Entidade ativa no tenant {{ tenant_id }}
              </label>
              <div class="form-text">
                Entidades inativas não aparecem em listagens públicas do tenant.
              </div>
            </div>
          </div>

          {# Informações do Tenant (somente leitura) #}
          <div class="mb-3">
            <div class="border rounded p-3 bg-light">
              <h6 class="mb-2">
                <i class="fas fa-info-circle me-1"></i>
                Informações do Tenant
              </h6>
              <div class="row">
                <div class="col-md-6">
                  <small class="text-muted">ID do Tenant:</small>
                  <div class="tenant-badge">{{ tenant_id }}</div>
                </div>
                <div class="col-md-6">
                  <small class="text-muted">Isolamento:</small>
                  <div><span class="badge bg-success">Ativo</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <div class="d-flex justify-content-between">
            <a href="/admin/design-patterns-tenant" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>

            <div>
              <button type="reset" class="btn btn-outline-secondary me-2">
                <i class="fas fa-undo me-2"></i>Limpar
              </button>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i>
                {{ action == 'create' ? 'Criar Entidade' : 'Salvar Alterações' }}
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endmacro %}

{# Sub-template: Visualização de detalhes #}
{% macro entityShow(entity, tenant_id) %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-eye me-2"></i>Detalhes da Entidade
          <span class="tenant-badge ms-2">Tenant {{ tenant_id }}</span>
        </h5>
        <span class="badge {{ entity.active ? 'bg-success' : 'bg-secondary' }} fs-6">
          {{ entity.active ? 'Ativo' : 'Inativo' }}
        </span>
      </div>

      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>Nome:</strong>
            <p class="mb-0">{{ entity.name }}</p>
          </div>

          <div class="col-md-6 mb-3">
            <strong>Slug:</strong>
            <p class="mb-0"><code>{{ entity.slug }}</code></p>
          </div>
        </div>

        {% if entity.description %}
        <div class="mb-3">
          <strong>Descrição:</strong>
          <p class="mb-0">{{ entity.description|nl2br }}</p>
        </div>
        {% endif %}

        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>Tenant ID:</strong>
            <p class="mb-0">
              <span class="tenant-badge">{{ entity.tenantId }}</span>
            </p>
          </div>

          <div class="col-md-6 mb-3">
            <strong>Status:</strong>
            <p class="mb-0">
              <span class="badge {{ entity.active ? 'bg-success' : 'bg-secondary' }}">
                {{ entity.active ? 'Ativo' : 'Inativo' }}
              </span>
            </p>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>Criado em:</strong>
            <p class="mb-0">{{ entity.createdAt|date('d/m/Y H:i:s') }}</p>
          </div>

          {% if entity.updatedAt %}
          <div class="col-md-6 mb-3">
            <strong>Atualizado em:</strong>
            <p class="mb-0">{{ entity.updatedAt|date('d/m/Y H:i:s') }}</p>
          </div>
          {% endif %}
        </div>

        {# Informações de segurança #}
        <div class="security-info mt-4">
          <h6 class="mb-2">
            <i class="fas fa-shield-alt me-1"></i>
            Informações de Segurança
          </h6>
          <ul class="mb-0 small">
            <li>Esta entidade pertence exclusivamente ao tenant {{ entity.tenantId }}</li>
            <li>Não é visível ou acessível por outros tenants</li>
            <li>Todas as operações são registradas em logs de auditoria</li>
            <li>Slug é único apenas dentro deste tenant</li>
          </ul>
        </div>
      </div>

      <div class="card-footer">
        <div class="d-flex justify-content-between">
          <a href="/admin/design-patterns-tenant" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar à Lista
          </a>

          <div>
            <a href="/admin/design-patterns-tenant/{{ entity.id }}/edit" class="btn btn-warning me-2">
              <i class="fas fa-edit me-2"></i>Editar
            </a>
            <button type="button" class="btn btn-danger btn-delete" 
              data-entity-id="{{ entity.id }}"
              data-entity-name="{{ entity.name|escape('html_attr') }}"
              data-tenant-id="{{ entity.tenantId }}">
              <i class="fas fa-trash me-2"></i>Excluir
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% block scripts %}
<script>
  // Validação de formulário client-side com segurança multi-tenant
  ( function () {
    'use strict';

    // Validação Bootstrap
    const forms = document.querySelectorAll( '.needs-validation, form[novalidate]' );
    Array.from( forms ).forEach( function ( form ) {
      form.addEventListener( 'submit', function ( event ) {
        // Validação adicional de segurança multi-tenant
        if ( !validateTenantSecurity( form ) ) {
          event.preventDefault();
          event.stopPropagation();
          alert( 'Erro de validação de segurança detectado. A operação foi cancelada.' );
          return;
        }

        if ( !form.checkValidity() ) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add( 'was-validated' );
      }, false );
    } );

    // Validação de segurança multi-tenant
    function validateTenantSecurity( form ) {
      const expectedTenantId = form.dataset.tenantValidation;
      const hiddenTenantId = document.getElementById( 'hidden-tenant-id' );

      if ( !expectedTenantId || !hiddenTenantId ) {
        return true; // Não aplicável
      }

      // Verificar se tenant_id não foi manipulado
      if ( hiddenTenantId.value !== expectedTenantId ) {
        // Log de segurança client-side
        console.error( 'SECURITY: Tentativa de manipulação cross-tenant detectada', {
          expected: expectedTenantId,
          provided: hiddenTenantId.value,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent
        } );

        // Tentar reportar para o servidor (opcional)
        try {
          fetch( '/api/security/report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify( {
              type: 'cross_tenant_manipulation_attempt',
              expected_tenant: expectedTenantId,
              provided_tenant: hiddenTenantId.value,
              url: window.location.href,
              timestamp: new Date().toISOString()
            } )
          } );
        } catch ( e ) {
          // Falha silenciosa no log remoto
        }

        return false;
      }

      return true;
    }

    // Auto-geração de slug
    const nameField = document.getElementById( 'name' );
    const slugField = document.getElementById( 'slug' );

    if ( nameField && slugField ) {
      nameField.addEventListener( 'input', function () {
        if ( slugField.value === '' || slugField.dataset.autoGenerated === 'true' ) {
          const slug = generateSlug( this.value );
          slugField.value = slug;
          slugField.dataset.autoGenerated = 'true';
        }
      } );

      slugField.addEventListener( 'input', function () {
        this.dataset.autoGenerated = 'false';
      } );
    }

    function generateSlug( text ) {
      return text
        .toLowerCase()
        .normalize( 'NFD' )
        .replace( /[\u0300-\u036f]/g, '' ) // Remove acentos
        .replace( /[^a-z0-9\s-]/g, '' ) // Remove caracteres especiais
        .trim()
        .replace( /\s+/g, '-' ) // Substitui espaços por hífens
        .replace( /-+/g, '-' ); // Remove hífens duplos
    }
  } )();

  // Confirmação de exclusão com validação de tenant
  function confirmDelete( id, name, tenantId ) {
    const expectedTenantId = document.querySelector( '[data-tenant-validation]' )?.dataset.tenantValidation;
    
    // Validação adicional de segurança
    if ( expectedTenantId && tenantId.toString() !== expectedTenantId ) {
      console.error( 'SECURITY: Tentativa de exclusão cross-tenant detectada', {
        expected: expectedTenantId,
        provided: tenantId,
        entityId: id,
        timestamp: new Date().toISOString()
      } );
      alert( 'Erro de segurança: Operação não autorizada.' );
      return;
    }

    const message = `Tem certeza que deseja excluir a entidade "${name}"?\n\n` +
                   `Tenant: ${tenantId}\n` +
                   `Esta ação não pode ser desfeita.\n\n` +
                   `A exclusão será registrada nos logs de auditoria.`;

    if ( confirm( message ) ) {
      // Criar form para DELETE
      const form = document.createElement( 'form' );
      form.method = 'POST';
      form.action = `/admin/design-patterns-tenant/${id}`;

      const methodInput = document.createElement( 'input' );
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.value = 'DELETE';

      // Adicionar tenant_id para validação adicional
      const tenantInput = document.createElement( 'input' );
      tenantInput.type = 'hidden';
      tenantInput.name = 'tenant_id';
      tenantInput.value = tenantId;

      form.appendChild( methodInput );
      form.appendChild( tenantInput );
      document.body.appendChild( form );
      form.submit();
    }
  }

  // Event listeners para botões de exclusão
  document.addEventListener( 'DOMContentLoaded', function () {
    const deleteButtons = document.querySelectorAll( '.btn-delete' );
    deleteButtons.forEach( button => {
      button.addEventListener( 'click', function () {
        const entityId = this.dataset.entityId;
        const entityName = this.dataset.entityName;
        const tenantId = this.dataset.tenantId;
        confirmDelete( entityId, entityName, tenantId );
      } );
    } );
  } );

</script>
{% endblock %}