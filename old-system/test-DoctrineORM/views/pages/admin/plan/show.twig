{% extends "layout.twig" %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Detalhes da Assinatura #{{ subscription.id }}</h1>
    <a href="javascript:history.back()" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar para a Lista
    </a>
  </div>



  {# Mapeamento de status para classes de badge e traduções #}
  {% set status_map = {
  'pending': { 'class': 'bg-warning text-dark', 'text': 'Pendente' },
  'authorized': { 'class': 'bg-info text-dark', 'text': 'Autorizado' },
  'in_process': { 'class': 'bg-primary', 'text': 'Em Processamento' },
  'in_mediation': { 'class': 'bg-secondary', 'text': 'Em Mediação' },
  'active': { 'class': 'bg-success', 'text': 'Ativa' },
  'approved': { 'class': 'bg-success', 'text': 'Aprovado' },
  'recovered': { 'class': 'bg-success', 'text': 'Recuperado' },
  'rejected': { 'class': 'bg-danger', 'text': 'Rejeitado' },
  'cancelled': { 'class': 'bg-dark', 'text': 'Cancelado' },
  'refunded': { 'class': 'bg-light text-dark border', 'text': 'Estornado' },
  'charged_back': { 'class': 'bg-danger', 'text': 'Chargeback' }
  } %}

  <div class="row">
    <!-- Coluna de Detalhes da Assinatura e Pagamento -->
    <div class="col-md-8">
      <!-- Card de Detalhes da Assinatura -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-file-text-fill me-2"></i>Detalhes da Assinatura</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-6 mb-3">
              <strong>Plano:</strong><br>
              <span>{{ subscription.plan_name }}</span>
            </div>
            <div class="col-sm-6 mb-3">
              <strong>Prestador:</strong><br>
              <span>{{ subscription.provider_name }} (ID: {{ subscription.provider_id }})</span>
            </div>
            <div class="col-sm-6 mb-3">
              <strong>Status da Assinatura:</strong><br>
              <span class="badge {{ status_map[subscription.status]['class']|default('bg-secondary') }}">{{
                status_map[subscription.status]['text']|default(subscription.status|capitalize) }}</span>
            </div>
            <div class="col-sm-6 mb-3">
              <strong>Preço Pago:</strong><br>
              <span>R$ {{ subscription.transaction_amount|number_format(2, ',', '.') }}</span>
            </div>
            <div class="col-sm-6">
              <strong>Data de Início:</strong><br>
              <span>{{ subscription.start_date ? subscription.start_date|date("d/m/Y H:i") : 'N/A' }}</span>
            </div>
            <div class="col-sm-6">
              <strong>Data de Expiração:</strong><br>
              <span>{{ subscription.end_date ? subscription.end_date|date("d/m/Y H:i") : 'N/A' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Card de Detalhes do Pagamento -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-credit-card-fill me-2"></i>Detalhes do Pagamento (Mercado Pago)</h5>
        </div>
        <div class="card-body">
          {% if payment_found %}
          <div class="row">
            <div class="col-sm-6 mb-3"><strong>ID do Pagamento (MP):</strong><br><span>{{ payment.payment_id }}</span>
            </div>
            <div class="col-sm-6 mb-3"><strong>Status do Pagamento:</strong><br><span
                class="badge {{ status_map[payment.status]['class']|default('bg-secondary') }}">{{
                status_map[payment.status]['text']|default(payment.status|capitalize) }}</span></div>
            <div class="col-sm-6 mb-3"><strong>Método de Pagamento:</strong><br><span>{{
                payment.payment_method|capitalize }}</span></div>
            <div class="col-sm-6 mb-3"><strong>Valor da Transação:</strong><br><span>R$ {{
                payment.transaction_amount|number_format(2, ',', '.') }}</span></div>
            <div class="col-sm-6"><strong>Data de Criação:</strong><br><span>{{ payment.created_at|date("d/m/Y H:i")
                }}</span></div>
            <div class="col-sm-6"><strong>Última Atualização:</strong><br><span>{{ payment.updated_at|date("d/m/Y H:i")
                }}</span></div>
          </div>
          {% else %}
          <div class="alert alert-warning" role="alert">Nenhum registro de pagamento encontrado para esta assinatura.
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Coluna de Ações -->
    <div class="col-md-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Ações do Prestador</h5>
        </div>
        <div class="card-body d-grid gap-2">
          <a href="/admin/plans/provider-history/{{ subscription.provider_id }}" class="btn btn-info">
            <i class="bi bi-clock-history me-2"></i>Ver Histórico do Prestador
          </a>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-gear-fill me-2"></i>Ações Administrativas</h5>
        </div>
        <div class="card-body">
          {% if payment_found %}
          {% set pending_statuses = ['pending', 'authorized', 'in_process', 'in_mediation'] %}
          {% if payment.status in pending_statuses %}
          <p class="text-muted small">O pagamento desta assinatura ainda não foi concluído. Você pode cancelá-lo para
            permitir que o usuário tente novamente.</p>
          <form action="/admin/plans/subscription/{{ subscription.id }}/cancel" method="POST" class="d-grid"
            id="cancelForm">
            {{ csrf.field|raw }}
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#cancelModal">
              <i class="bi bi-x-circle me-2"></i>Cancelar Pagamento Pendente
            </button>
          </form>
          {% elseif payment.status == 'approved' %}
          <p class="text-muted small">Este pagamento foi aprovado. Você pode estornar o valor para o cliente, o que
            também cancelará a assinatura.</p>
          <form action="/admin/plans/subscription/{{ subscription.id }}/refund" method="POST" class="d-grid"
            id="refundForm">
            {{ csrf.field|raw }}
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#refundModal">
              <i class="bi bi-arrow-counterclockwise me-2"></i>Estornar Pagamento
            </button>
          </form>

          {% else %}
          <div class="alert alert-info" role="alert">Nenhuma ação disponível para o status de pagamento atual ({{
            status_map[payment.status]['text']|default(payment.status|capitalize) }}).</div>
          {% endif %}
          {% else %}
          <div class="alert alert-secondary" role="alert">Nenhuma ação disponível, pois não há pagamento associado.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação para Cancelar -->
<div class="modal fade" id="cancelModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Cancelamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja cancelar este pagamento pendente?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-warning"
          onclick="document.getElementById('cancelForm').submit();">Confirmar Cancelamento</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação para Estorno -->
<div class="modal fade" id="refundModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Estorno</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja estornar este pagamento?</p>
        <p class="text-danger"><strong>Atenção:</strong> A ação não pode ser desfeita e o valor será devolvido ao
          cliente.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" onclick="document.getElementById('refundForm').submit();">Confirmar
          Estorno</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
