name: Deploy via FTP

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: curl gd pdo pdo_mysql intl zip

      - name: Install zip and rsync
        run: sudo apt-get install -y zip unzip rsync

      # ===========================================
      # CONFIGURAÇÃO: Preparar ambiente
      # ===========================================
      - name: Setup environment
        run: cp .env.production .env

      # ===========================================
      # DEPENDÊNCIAS: Instalar composer e npm
      # ===========================================
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Cache NPM packages
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --no-scripts

      - name: Install NPM dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      # ===========================================
      # OTIMIZAÇÃO: Cache do Laravel
      # ===========================================
      - name: Generate Laravel config cache
        run: php artisan config:cache

      - name: Generate Laravel route cache
        run: php artisan route:cache

      - name: Generate Laravel events cache
        run: php artisan event:cache

      # ===========================================
      # PREPARAÇÃO: Criar public_html/
      # ===========================================
      - name: Prepare public_html folder
        run: |
          # Copiar public/index.php para public_html/index.php
          cp public/index.php public_html/index.php

          # Criar .htaccess para public_html (web root do Locaweb)
          cat > public_html/.htaccess << 'HTACCESS'
          <IfModule mod_rewrite.c>
              <IfModule mod_negotiation.c>
                  Options -MultiViews -Indexes
              </IfModule>

              RewriteEngine On

              # Handle Authorization Header
              RewriteCond %{HTTP:Authorization} .
              RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

              # Redirect all requests to public/ folder (Laravel structure)
              RewriteCond %{REQUEST_FILENAME} !-f
              RewriteCond %{REQUEST_FILENAME} !-d
              RewriteRule ^ public/index.php [L]
          </IfModule>
          HTACCESS

          # Verificar criação
          ls -la public_html/

      # ===========================================
      # DEPLOY: FTP para Locaweb
      # ===========================================
      - name: FTP Deploy to Locaweb
        uses: mntndev/ftp-deploy-action@v0.1.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          local-dir: ./
          server-dir: /
          exclude: |
            **/.git/**
            **/.gitignore
            **/Thumbs.db
            **/*.log
            **/node_modules/**
            **/vendor/**
            **/tests/**
            **/.github/**
            **/coverage/**
          arg-overrides: |
            --verbose
            --ignore-existing
