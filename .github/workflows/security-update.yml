name: Security Update

on:
  schedule:
    # Executa diariamente às 6:00 UTC
    - cron: "0 6 * * *"
  # Permite execução manual
  workflow_dispatch:

jobs:
  security-update:
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev-junior' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, intl, pdo, pdo_mysql
          coverage: none

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --optimize-autoloader --no-progress --no-interaction

      - name: Check for security vulnerabilities
        id: audit
        run: |
          output=$(composer audit --format=json 2>&1)
          echo "$output"
          if echo "$output" | grep -q "vulnerabilities"; then
            echo "vulnerable=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerable=false" >> $GITHUB_OUTPUT
          fi

      - name: Update vulnerable dependencies
        if: steps.audit.outputs.vulnerable == 'true'
        run: |
          echo "Security vulnerabilities found! Updating dependencies..."
          composer update --no-progress --no-interaction

          # Verificar se houve mudanças
          if git diff --name-only composer.lock | grep -q "composer.lock"; then
            echo "Changes detected in composer.lock"

            # Criar commit automático
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add composer.json composer.lock
            git commit -m "Security: Update dependencies to fix vulnerabilities [skip ci]" || echo "No changes to commit"

            # Push para o repositório
            git push || echo "Push failed,可能是没有权限"
          else
            echo "No changes to composer.lock after update"
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Create Pull Request for security updates
        if: ${{ failure() && env.GH_TOKEN != '' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "Security: Update dependencies to fix vulnerabilities"
          title: "Security Update - Fix Vulnerabilities"
          body: |
            Este PR atualiza as dependências para corrigir vulnerabilidades de segurança detectadas.

            ## Vulnerabilidades Corrigidas
            - phpunit/phpunit: Atualizado para versão segura
            - psy/psysh: Atualizado para versão segura
            - symfony/process: Atualizado para versão segura

            Executado automaticamente pelo GitHub Actions.
          branch: security-update
          base: master
          delete-branch: true
